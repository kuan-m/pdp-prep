## [На главную](../../README.md)
# PHP-FPM Performance Testing

## Оглавление

1. [Введение](#введение)
2. [Описание микросервисов](#описание-микросервисов)
   - [Low (Низкая нагрузка)](#low-низкая-нагрузка)
   - [Mid (Средняя нагрузка)](#mid-средняя-нагрузка)
   - [High (Высокая нагрузка)](#high-высокая-нагрузка)
3. [Требования к железу и серверам](#требования-к-железу-и-серверам)
4. [Детальное описание параметров PHP-FPM](#детальное-описание-параметров-php-fpm)
5. [Доступ к сервисам](#доступ-к-сервисам)
6. [Тестирование производительности](#тестирование-производительности)
7. [Руководство по метрикам](#руководство-по-метрикам)
8. [Ожидаемые результаты](#ожидаемые-результаты)

---

## Введение

### Тема
2. PHP-FPM

### Практика
Настроить PHP-FPM локально:
- изменить параметры `pm`, `max_children`, `max_requests`
- замерить, как меняется производительность при нагрузке

### Ресурсы
[Demystifying Nginx and PHP-FPM for PHP Developers](https://medium.com/@mgonzalezbaile/demystifying-nginx-and-php-fpm-for-php-developers-bba548dd38f9)

---

## Описание микросервисов

В проекте созданы три микросервиса PHP-FPM с разными конфигурациями для различных уровней нагрузки.

### Low (Низкая нагрузка)

**Конфигурация:**
- **Process Manager**: `static` - фиксированное количество процессов
- **pm.max_children**: `5` - максимум 5 дочерних процессов
- **pm.max_requests**: `500` - перезапуск процесса после 500 запросов
- **Порт Nginx**: `8083`

**Характеристики:**
- Минимальное потребление ресурсов (~250MB RAM)
- Предсказуемое поведение
- Меньше накладных расходов на управление процессами
- Не адаптируется к изменению нагрузки

**Сценарии использования:**
- Разработка и тестирование
- Низкотрафичные сайты (< 1000 посетителей/день)

### Mid (Средняя нагрузка)

**Конфигурация:**
- **Process Manager**: `dynamic` - динамическое управление процессами
- **pm.max_children**: `20` - максимум 20 дочерних процессов
- **pm.start_servers**: `5` - начальное количество процессов
- **pm.min_spare_servers**: `3` - минимум простаивающих процессов
- **pm.max_spare_servers**: `10` - максимум простаивающих процессов
- **pm.max_requests**: `750` - перезапуск процесса после 750 запросов
- **Порт Nginx**: `8084`

**Характеристики:**
- Баланс между производительностью и ресурсами (~1GB RAM)
- Динамическая адаптация к нагрузке
- Хорошая обработка переменного трафика

**Сценарии использования:**
- Средние сайты (1000-10000 посетителей/день)

### High (Высокая нагрузка)

**Конфигурация:**
- **Process Manager**: `dynamic` - динамическое управление процессами
- **pm.max_children**: `50` - максимум 50 дочерних процессов
- **pm.start_servers**: `10` - начальное количество процессов
- **pm.min_spare_servers**: `5` - минимум простаивающих процессов
- **pm.max_spare_servers**: `20` - максимум простаивающих процессов
- **pm.max_requests**: `1000` - перезапуск процесса после 1000 запросов
- **Порт Nginx**: `8085`

**Характеристики:**
- Высокая пропускная способность (~2.5GB RAM)
- Лучшая обработка пиковых нагрузок
- Динамическая адаптация к нагрузке
- Требует больше ресурсов сервера

**Сценарии использования:**
- Высоконагруженные сайты (> 10000 посетителей/день)
- API с высоким трафиком

---

## Требования к железу и серверам

### Low (Низкая нагрузка)
**Kubernetes ресурсы:**
```yaml
resources:
  requests:
    memory: "256Mi"
    cpu: "1000m"
  limits:
    memory: "512Mi"
```

**Реальная производительность (тест: 50 соединений, 30 секунд):**
- **RPS (Requests/Sec)**: ~99 req/sec (среднее)
- **Latency p50**: 500 ms
- **Latency p99**: 601 ms
- **Latency avg**: 500.61 ms
- **Total requests**: ~2970 запросов за 30 секунд

**Примеры серверов:**
- VPS (1 CPU, 1GB RAM) - рекомендуется Low

### Mid (Средняя нагрузка)
**Kubernetes ресурсы:**
```yaml
resources:
  requests:
    memory: "512Mi"
    cpu: "1000m"
  limits:
    memory: "2Gi"
```

**Реальная производительность (тест: 50 соединений, 30 секунд):**
- **RPS (Requests/Sec)**: ~150.94 req/sec (среднее)
- **Latency p50**: 305 ms
- **Latency p99**: 601 ms
- **Latency avg**: 328.68 ms
- **Total requests**: ~4528 запросов за 30 секунд

**Примеры серверов:**
- VPS (2 CPU, 2GB RAM) - рекомендуется Mid

### High (Высокая нагрузка)
**Kubernetes ресурсы:**
```yaml
resources:
  requests:
    memory: "1Gi"
    cpu: "1000m"
  limits:
    memory: "3Gi"
```

**Реальная производительность (тест: 50 соединений, 30 секунд):**
- **RPS (Requests/Sec)**: ~152.27 req/sec (среднее)
- **Latency p50**: 302 ms
- **Latency p99**: 609 ms
- **Latency avg**: 326.44 ms
- **Total requests**: ~4568 запросов за 30 секунд

**Примеры серверов:**
- VPS (4 CPU, 4GB RAM) - рекомендуется High
- Dedicated Server (8 CPU, 16GB RAM) - High + горизонтальное масштабирование

---

## Детальное описание параметров PHP-FPM

### Process Manager (pm)

#### `pm = static`
**Описание**: Фиксированное количество процессов PHP-FPM

**Преимущества:**
- Предсказуемое потребление ресурсов
- Минимальные накладные расходы на управление процессами
- Стабильная производительность

**Недостатки:**
- Не адаптируется к изменению нагрузки
- Может быть узким местом при пиках

**Использование**: Low уровень нагрузки

#### `pm = dynamic`
**Описание**: Динамическое управление количеством процессов в зависимости от нагрузки

**Преимущества:**
- Адаптация к изменению нагрузки
- Эффективное использование ресурсов
- Лучшая обработка пиковых нагрузок

**Недостатки:**
- Больше накладных расходов на управление процессами
- Может потреблять больше памяти

**Использование**: Mid и High уровни нагрузки

### pm.max_children

**Описание**: Максимальное количество дочерних процессов PHP-FPM, которые могут быть запущены одновременно.

**Расчет для сервера:**
```
max_children = memory_limit / memory_per_process
RPS = max_children / p95_response_time
```

**Примеры:**
- **Low**: 5 процессов × ~50MB = ~250MB памяти
- **Mid**: 20 процессов × ~50MB = ~1GB памяти
- **High**: 50 процессов × ~50MB = ~2.5GB памяти


### pm.start_servers

**Описание**: Количество дочерних процессов, которые запускаются при старте PHP-FPM.

**Рекомендации:**
- Обычно устанавливается как `pm.max_children / 2` или `pm.min_spare_servers`
- Слишком большое значение увеличивает время старта
- Слишком маленькое значение может привести к задержкам при первых запросах

### pm.min_spare_servers

**Описание**: Минимальное количество простаивающих процессов, которые должны быть готовы обрабатывать запросы.

**Рекомендации:**
- Обычно `pm.max_children / 4` или `pm.start_servers / 2`
- Обеспечивает быструю обработку внезапных запросов
- Слишком большое значение приводит к избыточному потреблению памяти

### pm.max_spare_servers

**Описание**: Максимальное количество простаивающих процессов. Если простаивающих процессов больше, лишние будут завершены.

**Рекомендации:**
- Обычно `pm.max_children / 2` или `pm.start_servers × 2`
- Балансирует между готовностью к нагрузке и экономией ресурсов
- Предотвращает избыточное потребление памяти в периоды низкой нагрузки

### pm.max_requests

**Описание**: Количество запросов, после обработки которых процесс PHP-FPM будет автоматически перезапущен.

**Зачем это нужно:**
- Предотвращает утечки памяти
- Обеспечивает "свежесть" процессов
- Помогает избежать накопления ошибок в долгоживущих процессах

**Рекомендации:**
- **Low**: 500 - более частый перезапуск для экономии памяти
- **Mid**: 750 - баланс между производительностью и стабильностью
- **High**: 1000 - меньше перезапусков для максимальной производительности

**Важно**: Слишком маленькое значение снижает производительность из-за частых перезапусков. Слишком большое значение может привести к утечкам памяти.

---

## Доступ к сервисам

- **Low**: `http://localhost:8083/2_php_fpm/test.php`
- **Mid**: `http://localhost:8084/2_php_fpm/test.php`
- **High**: `http://localhost:8085/2_php_fpm/test.php`

---

## Тестирование производительности

### Установка autocannon

```bash
npm install -g autocannon
# или используйте npx (уже установлен в проекте)
```

### Запуск нагрузочного тестирования

#### Использование Makefile (рекомендуется)

```bash
# Тестирование всех трех сервисов
make test-all

# Тестирование конкретного сервиса
make test-low
make test-mid
make test-high

# Тестирование с кастомными параметрами
make test-low CONNECTIONS=200 DURATION=60
```

#### Ручной запуск

**Параметры autocannon:**
- `-c, --connections <num>` - количество одновременных соединений (по умолчанию: 10)
- `-d, --duration <sec>` - длительность теста в секундах (по умолчанию: 10)

**Тестирование Low сервиса:**
```bash
# Тяжелый скрипт: 100 одновременных соединений, 30 секунд
npx autocannon -c 100 -d 30 http://localhost:8083/2_php_fpm/test.php

# Легкий скрипт: 100 одновременных соединений, 30 секунд
npx autocannon -c 100 -d 30 http://localhost:8083/2_php_fpm/test-light.php
```

**Тестирование Mid сервиса:**
```bash
# Тяжелый скрипт: 100 одновременных соединений, 30 секунд
npx autocannon -c 100 -d 30 http://localhost:8084/2_php_fpm/test.php

# Легкий скрипт: 100 одновременных соединений, 30 секунд
npx autocannon -c 100 -d 30 http://localhost:8084/2_php_fpm/test-light.php
```

**Тестирование High сервиса:**
```bash
# Тяжелый скрипт: 100 одновременных соединений, 30 секунд
npx autocannon -c 100 -d 30 http://localhost:8085/2_php_fpm/test.php

# Легкий скрипт: 100 одновременных соединений, 30 секунд
npx autocannon -c 100 -d 30 http://localhost:8085/2_php_fpm/test-light.php
```

---

## Руководство по метрикам

### Метрики autocannon

#### 1. Latency (Задержка) - САМОЕ ВАЖНОЕ

```
┌─────────┬────────┬────────┬────────┬────────┬───────────┬───────────┬────────┐
│ Stat    │ 2.5%   │ 50%    │ 97.5%  │ 99%    │ Avg       │ Stdev     │ Max    │
├─────────┼────────┼────────┼────────┼────────┼───────────┼───────────┼────────┤
│ Latency │ 109 ms │ 302 ms │ 594 ms │ 609 ms │ 326.44 ms │ 115.42 ms │ 794 ms │
└─────────┴────────┴────────┴────────┴────────┴───────────┴───────────┴────────┘
```
*Пример: High сервис (50 соединений, 30 секунд)*

**Что это значит:**
- **Latency** - время от отправки запроса до получения ответа

**Ключевые метрики:**

1. **50% (медиана)** - время ответа для половины запросов
   - ✅ **Хорошо**: < 100ms
   - ⚠️ **Приемлемо**: 100-500ms
   - ❌ **Плохо**: > 500ms

2. **99% (p99)** - время ответа для 99% запросов
   - Показывает худшие случаи
   - ✅ **Хорошо**: < 200ms
   - ⚠️ **Приемлемо**: 200-1000ms
   - ❌ **Плохо**: > 1000ms

3. **Avg (среднее)** - среднее время ответа
   - Полезно для общего понимания

4. **Stdev (стандартное отклонение)** - разброс значений
   - Меньше = стабильнее

5. **Max** - максимальное время ответа
   - Показывает выбросы (может быть из-за холодного старта, GC и т.д.)

**Что искать:**
- ✅ **Низкая latency** = быстрый ответ
- ✅ **Маленький разброс (Stdev)** = стабильная производительность
- ✅ **Низкий p99** = большинство запросов обрабатываются быстро

#### 2. Req/Sec (Requests per Second) - ПРОПУСКНАЯ СПОСОБНОСТЬ

```
┌───────────┬───────┬───────┬─────────┬─────────┬─────────┬─────────┬───────┐
│ Stat      │ 1%    │ 2.5%  │ 50%     │ 97.5%   │ Avg     │ Stdev   │ Min   │
├───────────┼───────┼───────┼─────────┼─────────┼─────────┼─────────┼───────┤
│ Req/Sec   │ 116   │ 116   │ 150     │ 188     │ 152.27  │ 15.01   │ 116   │
└───────────┴───────┴───────┴─────────┴─────────┴─────────┴─────────┴───────┘
```
*Пример: High сервис (50 соединений, 30 секунд)*

**Что это значит:**
- **Req/Sec** - сколько запросов обрабатывается в секунду

**Ключевые метрики:**

1. **Avg (среднее)** - средняя пропускная способность
   - Чем выше, тем лучше

2. **50% (медиана)** - типичная пропускная способность

3. **Min/Max** - минимальная/максимальная пропускная способность
   - Показывает стабильность

**Что искать:**
- ✅ **Высокий Req/Sec** = больше запросов обрабатывается
- ✅ **Стабильный Req/Sec** (маленький Stdev) = постоянная производительность
- ✅ **Высокий Min** = даже в худшие моменты производительность хорошая

#### 3. Bytes/Sec (Пропускная способность данных)

**Что это значит:**
- Сколько данных передается в секунду

**Когда это важно:**
- Для больших ответов (файлы, изображения)
- Для Ро теста не критично (JSON ответы маленькие)

#### 4. Total requests (Общее количество запросов)

**Что это значит:**
- Общее количество успешно обработанных запросов за время теста

---

## Ожидаемые результаты

### Сравнение результатов

**Тестовые параметры:** 50 соединений, 30 секунд

| Метрика | Low | Mid | High | Разница (Low→High) | Оценка |
|---------|-----|-----|------|-------------------|--------|
| **Req/Sec avg** | 99 req/sec | 150.94 req/sec | 152.27 req/sec | **+54%** | ✅ High в 1.5x быстрее |
| **Latency p50** | 500 ms | 305 ms | 302 ms | **-40%** | ✅ High быстрее |
| **Latency p99** | 601 ms | 601 ms | 609 ms | +1% | ≈ Одинаковая стабильность |
| **Latency avg** | 500.61 ms | 328.68 ms | 326.44 ms | **-35%** | ✅ High быстрее |
| **Stdev (Latency)** | 49.77 ms | 103.37 ms | 115.42 ms | +132% | ⚠️ Больше разброс |
| **Total requests** | 2970 | 4528 | 4568 | **+54%** | ✅ High обработал больше |
| **Memory requests** | 256Mi | 512Mi | 4Gi | +1500% | ⚠️ Больше ресурсов |
| **Memory limits** | 512Mi | 2Gi | 6Gi | +1075% | ⚠️ Больше ресурсов |
| **CPU requests** | 100m | 500m | 4000m | +3900% | ⚠️ Больше ресурсов |
| **CPU limits** | 1000m | 2000m | не ограничен | - | ⚠️ High без лимита |

### Low (pm=static, max_children=5)

**Преимущества:**
- Низкое потребление памяти (~250MB)
- Предсказуемое поведение
- Меньше накладных расходов на управление процессами
- Минимальные требования к ресурсам

**Недостатки:**
- Ограниченная пропускная способность при высокой нагрузке
- Может быть узким местом при большом количестве одновременных запросов
- Не адаптируется к изменению нагрузки

**Реальные метрики при нагрузке 50 соединений:**
- RPS: **99 req/sec** (среднее)
- Latency p50: **500 ms**
- Latency p99: **601 ms**
- Latency avg: **500.61 ms**
- Total requests: **2970** за 30 секунд

**Когда использовать:**
- Низкая и предсказуемая нагрузка (< 1000 посетителей/день)
- Ограниченные ресурсы сервера (1 CPU, 512MB RAM)

### Mid (pm=dynamic, max_children=20)

**Преимущества:**
- Баланс между производительностью и ресурсами
- Динамическая адаптация к нагрузке
- Хорошая обработка переменного трафика
- Умеренное потребление памяти (~1GB)

**Недостатки:**
- Больше накладных расходов на управление процессами, чем у Low
- Может быть недостаточно для очень высокой нагрузки

**Реальные метрики при нагрузке 50 соединений:**
- RPS: **150.94 req/sec** (среднее)
- Latency p50: **305 ms**
- Latency p99: **601 ms**
- Latency avg: **328.68 ms**
- Total requests: **4528** за 30 секунд

**Когда использовать:**
- Средняя нагрузка (1000-10000 посетителей/день)
- Средние ресурсы сервера (2 CPU, 1-2GB RAM)

### High (pm=dynamic, max_children=50)

**Преимущества:**
- Высокая пропускная способность
- Лучшая обработка пиковых нагрузок
- Динамическая адаптация к нагрузке
- Оптимизирован для высокой производительности

**Недостатки:**
- Выше потребление памяти (~2.5GB)
- Больше накладных расходов на управление процессами
- Требует больше ресурсов сервера

**Реальные метрики при нагрузке 50 соединений:**
- RPS: **152.27 req/sec** (среднее)
- Latency p50: **302 ms**
- Latency p99: **609 ms**
- Latency avg: **326.44 ms**
- Total requests: **4568** за 30 секунд

**Когда использовать:**
- Высокая нагрузка (> 10000 посетителей/день)
- Достаточные ресурсы сервера (4+ CPU, 2+ GB RAM)
- Необходимость обработки пиковых нагрузок
- Важна высокая пропускная способность

---
### Признаки необходимости изменения уровня

#### Переход с Low на Mid:
- Постоянное использование всех процессов (pm.max_children)
- Высокая задержка (p50 > 400ms, p99 > 600ms)
- Ошибки 502/503 при нагрузке
- RPS постоянно > 100 req/sec
- Latency avg > 450ms

#### Переход с Mid на High:
- Постоянное использование всех процессов (pm.max_children)
- Высокая задержка (p50 > 300ms, p99 > 600ms)
- Ошибки 502/503 при нагрузке
- RPS постоянно > 150 req/sec
- Latency avg > 350ms

#### Переход с High на более мощный сервер:
- Постоянное использование всех процессов (pm.max_children)
- Высокая задержка даже при достаточных процессах (p50 > 300ms)
- RPS постоянно > 200 req/sec
- Latency avg > 350ms

---
