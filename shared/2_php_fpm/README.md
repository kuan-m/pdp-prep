# PHP-FPM Performance Testing

## Тема
2. PHP-FPM

## Практика
2. Настроить PHP-FPM локально:
   - изменить параметры `pm`, `max_children`, `max_requests`,
   - замерить, как меняется производительность при нагрузке

## Ресурсы
2. [Demystifying Nginx and PHP-FPM for PHP Developers](https://medium.com/@mgonzalezbaile/demystifying-nginx-and-php-fpm-for-php-developers-bba548dd38f9)

---

## Описание микросервисов

В проекте созданы два микросервиса PHP-FPM с разными конфигурациями для тестирования производительности:

### 1. PHP-FPM Default (Настройка по умолчанию)
- **Process Manager**: `static` - фиксированное количество процессов
- **max_children**: `5` - максимум 5 дочерних процессов
- **max_requests**: `500` - перезапуск процесса после 500 запросов
- **Порт Nginx**: `8083`
- **Описание**: Минимальное потребление ресурсов, подходит для низкой нагрузки

### 2. PHP-FPM Aggressive (Агрессивная настройка)
- **Process Manager**: `dynamic` - динамическое управление процессами
- **max_children**: `50` - максимум 50 дочерних процессов
- **start_servers**: `10` - начальное количество процессов
- **min_spare_servers**: `5` - минимум простаивающих процессов
- **max_spare_servers**: `20` - максимум простаивающих процессов
- **max_requests**: `1000` - перезапуск процесса после 1000 запросов
- **Порт Nginx**: `8084`
- **Описание**: Высокая производительность, подходит для высокой нагрузки

---

## Доступ к сервисам

- **Default**: `http://localhost:8083/2_php_fpm/test.php`
- **Aggressive**: `http://localhost:8084/2_php_fpm/test.php`


## Тестирование производительности

### Установка autocannon

```bash
npm install -g autocannon
# или используйте npx (уже установлен в проекте)
```

### Доступные тестовые скрипты

1. **test.php** - тяжелый скрипт (100,000 итераций)
   - Создает значительную нагрузку на CPU
   - Полезен для тестирования под высокой нагрузкой
   - Latency: ~1000-2000ms

2. **test-light.php** - легкий скрипт (10,000 итераций)
   - Более реалистичная нагрузка
   - Полезен для тестирования в нормальных условиях
   - Latency: ~50-200ms

### Запуск нагрузочного тестирования

#### Тестирование Default сервиса

```bash
# Тяжелый скрипт: 100 одновременных соединений, 30 секунд
npx autocannon -c 100 -d 30 http://localhost:8083/2_php_fpm/test.php

# Легкий скрипт: 100 одновременных соединений, 30 секунд
npx autocannon -c 100 -d 30 http://localhost:8083/2_php_fpm/test-light.php

# Более агрессивная нагрузка: 200 соединений, 60 секунд
npx autocannon -c 200 -d 60 http://localhost:8083/2_php_fpm/test.php
```

#### Тестирование Aggressive сервиса

```bash
# Тяжелый скрипт: 100 одновременных соединений, 30 секунд
npx autocannon -c 100 -d 30 http://localhost:8084/2_php_fpm/test.php

# Легкий скрипт: 100 одновременных соединений, 30 секунд
npx autocannon -c 100 -d 30 http://localhost:8084/2_php_fpm/test-light.php

# Более агрессивная нагрузка: 200 соединений, 60 секунд
npx autocannon -c 200 -d 60 http://localhost:8084/2_php_fpm/test.php
```

### Параметры autocannon

- `-c, --connections <num>` - количество одновременных соединений (по умолчанию: 10)
- `-d, --duration <sec>` - длительность теста в секундах (по умолчанию: 10)

---

## Метрики для мониторинга

### 1. Метрики autocannon
- **Latency** (Задержка):
  - `avg` - средняя задержка
  - `min` - минимальная задержка
  - `max` - максимальная задержка
  - `p50`, `p90`, `p99` - перцентили задержки

- **Throughput** (Пропускная способность):
  - `requests/sec` - количество запросов в секунду
  - `throughput` - объем данных в секунду

- **Requests**:
  - `total` - общее количество запросов
  - `sent` - отправлено запросов
  - `errors` - количество ошибок

- **Duration**:
  - `duration` - длительность теста
  - `start` - время начала
  - `finish` - время окончания

---

## Ожидаемые результаты
Aggressive сервис демонстрирует ожидаемое превосходство при высокой нагрузке благодаря большему количеству процессов.

### Default (pm=static, max_children=5)

**Преимущества:**
- Низкое потребление памяти
- Предсказуемое поведение
- Меньше накладных расходов на управление процессами

**Недостатки:**
- Ограниченная пропускная способность при высокой нагрузке
- Может быть узким местом при большом количестве одновременных запросов

**Ожидаемые метрики при нагрузке 100 соединений:**
- RPS: ~50-100 запросов/сек (зависит от сложности скрипта)
- Latency p99: может быть высоким из-за очереди запросов
- Ошибки: возможны при превышении max_children

### Aggressive (pm=dynamic, max_children=50)

**Преимущества:**
- Высокая пропускная способность
- Лучшая обработка пиковых нагрузок
- Динамическая адаптация к нагрузке

**Недостатки:**
- Выше потребление памяти
- Больше накладных расходов на управление процессами

**Ожидаемые метрики при нагрузке 100 соединений:**
- RPS: ~200-500 запросов/сек (зависит от сложности скрипта)
- Latency p99: обычно ниже, чем у default
- Ошибки: меньше вероятность ошибок при высокой нагрузке

---

### Когда использовать Default (static, max_children=5):

- Низкая и предсказуемая нагрузка
- Ограниченные ресурсы сервера
- Необходимость минимального потребления памяти
- Стабильная нагрузка без пиков

### Когда использовать Aggressive (dynamic, max_children=50):

- Высокая и переменная нагрузка
- Достаточные ресурсы сервера
- Необходимость обработки пиковых нагрузок
- Важна высокая пропускная способность
